#!/usr/bin/env bash

# [Bash "strict mode"](http://redsymbol.net/articles/unofficial-bash-strict-mode/)
set -euo pipefail
IFS=$'\n\t'

bold=$(tput bold)
# green=$(tput setaf 2)
yellow=$(tput setaf 3)
reset=$(tput sgr0)

eval "$(pyenv init - bash)"

eecho() {
  echo "$@" >&2
}

print_and_execute() {
  echo "${bold}+" "$@" "$reset" >&2
  "$@"
}

__pyversions() {
  declare versions
  versions=$(pyenv versions --bare)
  printf "%s\n" "$versions"
}

__pyversion_exists() {
  local version=${1:-}
  if [[ -z $version ]]; then
    return 1
  fi
  __pyversions | rg -F "$version" >/dev/null
}

py_version=${1:-}
if [[ -z $py_version ]]; then
  py_version="$(pyenv version --bare)"
fi
eecho "Using Python version $py_version"

if __pyversion_exists "$py_version/envs/neovim"; then
  eecho "${bold}${yellow}A neovim venv already exists for this Python version.$reset"
  exit 0
fi
if __pyversion_exists "neovim"; then
  eecho "Found an existing neovim venv"
  print_and_execute virtualenv-delete -f neovim
fi
print_and_execute pyenv virtualenv "$py_version" neovim
print_and_execute pyenv shell neovim
print_and_execute python -m pip install -U pip
print_and_execute pip install neovim
